<?xml version="1.0" encoding="UTF-8"?>
<ruleset name="Custom Flow Ruleset - OWASP & Salesforce Security"
         xmlns="http://pmd.sourceforge.net/ruleset/3.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://pmd.sourceforge.net/ruleset/3.0.0
                             http://pmd.sourceforge.net/ruleset_3_0_0.xsd"
         xmlns:pmd="http://pmd.sourceforge.net/ruleset/3.0.0">

    <!-- Rule: Hardcoded Secrets -->
    <rule name="HardcodedSecrets"
          language="xml"
          message="Hardcoded secrets or passwords detected in Flow."
          class="net.sourceforge.pmd.lang.xml.rule.DomXPathRule">
        <description><![CDATA[
            Detects string values that look like passwords, API keys, or secrets.
        ]]></description>
        <priority>2</priority>
        <properties>
            <property name="xpath">
                <value><![CDATA[
                    //*:elements/*:assignmentItems/*:value/*:stringValue[matches(string(.), '(?i)(password|secret|api[_-]?key)')]
                ]]></value>
            </property>
        </properties>
    </rule>

    <!-- Rule: Embedded HTML or Script -->
    <rule name="EmbeddedHtmlOrScript"
          language="xml"
          message="Embedded HTML or script in strings may lead to XSS when displayed to users."
          class="net.sourceforge.pmd.lang.xml.rule.DomXPathRule">
        <description><![CDATA[
            Flags string values containing HTML tags or &lt;script&gt; tokens.
        ]]></description>
        <priority>2</priority>
        <properties>
            <property name="xpath">
                <value><![CDATA[
                    //*:elements/*:assignmentItems/*:value/*:stringValue[matches(string(.), '(?i)<[^>]+>|&lt;script&gt;')]
                ]]></value>
            </property>
        </properties>
    </rule>

    <!-- Rule: Flow SOQL Injection (detects dynamic SOQL in Apex invocable actions) -->
    <rule name="FlowSoqlInjection"
          language="xml"
          message="Potential dynamic SOQL usage in Flow could lead to injection."
          class="net.sourceforge.pmd.lang.xml.rule.DomXPathRule">
        <description><![CDATA[
            Detects dynamic SOQL strings in Apex invocable actions called from the Flow.
        ]]></description>
        <priority>1</priority>
        <properties>
            <property name="xpath">
                <value><![CDATA[
                    //*:elements/*:actionCall/*:apexClass[matches(string(.), '(?i)(execute|query).*\\{.*\\}')]
                ]]></value>
            </property>
        </properties>
    </rule>

    <!-- Rule: Hardcoded URLs / External Calls -->
    <rule name="HardcodedURLs"
          language="xml"
          message="Hardcoded external URLs in Flow assignments."
          class="net.sourceforge.pmd.lang.xml.rule.DomXPathRule">
        <description><![CDATA[
            Detects string values that contain http:// or https:// in Flow assignments.
        ]]></description>
        <priority>3</priority>
        <properties>
            <property name="xpath">
                <value><![CDATA[
                    //*:elements/*:assignmentItems/*:value/*:stringValue[matches(string(.), '(?i)https?://')]
                ]]></value>
            </property>
        </properties>
    </rule>

    <!-- Rule: Potential Sensitive Data Logging -->
    <rule name="SensitiveLogging"
          language="xml"
          message="Logging sensitive data in Flow assignments."
          class="net.sourceforge.pmd.lang.xml.rule.DomXPathRule">
        <description><![CDATA[
            Detects assignment strings that contain common sensitive data terms like SSN, password, token.
        ]]></description>
        <priority>2</priority>
        <properties>
            <property name="xpath">
                <value><![CDATA[
                    //*:elements/*:assignmentItems/*:value/*:stringValue[matches(string(.), '(?i)(ssn|password|token|creditcard)')]
                ]]></value>
            </property>
        </properties>
    </rule>

</ruleset>
