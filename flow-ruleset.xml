<?xml version="1.0" encoding="UTF-8"?>

<ruleset name="Advanced Flow Security and OWASP Top 10"
         xmlns="http://pmd.sourceforge.net/ruleset/3.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://pmd.sourceforge.net/ruleset/3.0.0
                             https://pmd.github.io/pmd-7.0.0/ruleset_3_0_0.xsd">

    <description>
        Advanced PMD ruleset for Salesforce Flow metadata.
        Covers OWASP Top 10 risks + common security vulnerabilities:
        - A01: Broken Access Control
        - A02: Cryptographic Failures
        - A03: Injection (SOQL, URL, HTML)
        - A04: Insecure Design
        - A05: Security Misconfiguration
        - A06: Vulnerable and Outdated Components
        - A07: Identification and Authentication Failures
        - A08: Software and Data Integrity Failures
        - A09: Security Logging and Monitoring Failures
        - A10: Server-Side Request Forgery (SSRF)
        Also detects hardcoded secrets, HTTP URLs, embedded scripts, unfiltered GetRecords, etc.
    </description>

    <!-- ====== Hardcoded Sensitive Data ====== -->
    <rule name="HardcodedSecrets"
          language="xml"
          message="Avoid hardcoded passwords, tokens, or API keys in Flow assignments."
          class="net.sourceforge.pmd.lang.xml.rule.DomXPathRule">
        <priority>2</priority>
        <properties>
            <property name="xpath">
                <value>
                    //*:elements/*:assignmentItems/*:value/*:stringValue[
                        matches(string(.), 'password|token|secret|apikey|key', 'i')
                    ]
                </value>
            </property>
        </properties>
    </rule>

    <!-- ====== Hardcoded Emails ====== -->
    <rule name="HardcodedEmailInAssignment"
          language="xml"
          message="Avoid hardcoded email addresses in Flow elements."
          class="net.sourceforge.pmd.lang.xml.rule.DomXPathRule">
        <priority>3</priority>
        <properties>
            <property name="xpath">
                <value>
                    //*:elements[*:type='Assignment']/*:assignmentItems/*:value/*:stringValue[
                        matches(string(.), '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$')
                    ]
                </value>
            </property>
        </properties>
    </rule>

    <!-- ====== Unfiltered GetRecords (Injection / Performance) ====== -->
    <rule name="UnfilteredGetRecords"
          language="xml"
          message="GetRecords elements without filters may lead to SOQL injection or performance issues."
          class="net.sourceforge.pmd.lang.xml.rule.DomXPathRule">
        <priority>2</priority>
        <properties>
            <property name="xpath">
                <value>
                    //*:elements[*:type='GetRecords' and not(*:getRecords/*:filterLogic)]
                </value>
            </property>
        </properties>
    </rule>

    <!-- ====== Empty Decision (Logic flaw / insecure design) ====== -->
    <rule name="EmptyDecision"
          language="xml"
          message="Decision element has no conditions defined."
          class="net.sourceforge.pmd.lang.xml.rule.DomXPathRule">
        <priority>3</priority>
        <properties>
            <property name="xpath">
                <value>
                    //*:elements[*:type='Decision' and not(*:decisions/*:conditions)]
                </value>
            </property>
        </properties>
    </rule>

    <!-- ====== Hardcoded Salesforce IDs ====== -->
    <rule name="HardcodedIdInFlow"
          language="xml"
          message="Avoid hardcoded Salesforce IDs in Flow assignments."
          class="net.sourceforge.pmd.lang.xml.rule.DomXPathRule">
        <priority>2</priority>
        <properties>
            <property name="xpath">
                <value>
                    //*:elements/*:assignmentItems/*:value/*:stringValue[
                        matches(string(.), '^[a-zA-Z0-9]{15}([a-zA-Z0-9]{3})?$')
                    ]
                </value>
            </property>
        </properties>
    </rule>

    <!-- ====== Insecure HTTP URLs ====== -->
    <rule name="InsecureHttpUrl"
          language="xml"
          message="Avoid hardcoded HTTP URLs."
          class="net.sourceforge.pmd.lang.xml.rule.DomXPathRule">
        <priority>3</priority>
        <properties>
            <property name="xpath">
                <value>
                    //*:elements/*:assignmentItems/*:value/*:stringValue[
                        contains(string(.), 'http://')
                    ]
                </value>
            </property>
        </properties>
    </rule>

    <!-- ====== Unused Variables ====== -->
    <rule name="UnusedVariables"
          language="xml"
          message="Flow variables should have isInput or isOutput flags set."
          class="net.sourceforge.pmd.lang.xml.rule.DomXPathRule">
        <priority>3</priority>
        <properties>
            <property name="xpath">
                <value>
                    //*:variables[not(@isInput) and not(@isOutput)]
                </value>
            </property>
        </properties>
    </rule>

    <!-- ====== Embedded HTML / Script (XSS) ====== -->
    <rule name="EmbeddedHtmlOrScript"
          language="xml"
          message="Embedded HTML or script may lead to XSS."
          class="net.sourceforge.pmd.lang.xml.rule.DomXPathRule">
        <priority>2</priority>
        <properties>
            <property name="xpath">
                <value>
                    //*:elements/*:assignmentItems/*:value/*:stringValue[
                        matches(string(.), '&lt;[^&gt;]+&gt;', 'i') or
                        matches(string(.), 'script', 'i')
                    ]
                </value>
            </property>
        </properties>
    </rule>

    <!-- ====== Sensitive Logging ====== -->
    <rule name="SensitiveLogging"
          language="xml"
          message="Avoid logging sensitive values in Flow assignments."
          class="net.sourceforge.pmd.lang.xml.rule.DomXPathRule">
        <priority>2</priority>
        <properties>
            <property name="xpath">
                <value>
                    //*:elements/*:assignmentItems/*:value/*:stringValue[
                        matches(string(.), 'password|token|secret|apikey|key', 'i')
                    ]
                </value>
            </property>
        </properties>
    </rule>

    <!-- ====== External Call / SSRF / Unsafe Endpoint ====== -->
    <rule name="UnsafeEndpoint"
          language="xml"
          message="Flow makes callout to external endpoint without HTTPS or whitelist."
          class="net.sourceforge.pmd.lang.xml.rule.DomXPathRule">
        <priority>2</priority>
        <properties>
            <property name="xpath">
                <value>
                    //*:elements/*:assignmentItems/*:value/*:stringValue[
                        matches(string(.), 'http://.*', 'i')
                    ]
                </value>
            </property>
        </properties>
    </rule>

    <!-- ===== GAP 1: Dynamic SOQL Concatenation ===== -->
    <rule name="DynamicSoqlConcatenation"
          language="xml"
          message="Assignment builds SOQL dynamically – risk of SOQL injection."
          class="net.sourceforge.pmd.lang.xml.rule.DomXPathRule">
        <priority>2</priority>
        <properties>
            <property name="xpath">
                <value>
                    //*:elements/*:assignmentItems/*:value/*:stringValue[
                        matches(string(.), 'SELECT.*FROM.*\\{!.*\\}', 'i')
                    ]
                </value>
            </property>
        </properties>
    </rule>

    <!-- ===== GAP 2: DML inside Loop ===== -->
    <rule name="DMLInLoop"
          language="xml"
          message="RecordCreate or RecordUpdate inside Loop may cause bulkification issues."
          class="net.sourceforge.pmd.lang.xml.rule.DomXPathRule">
        <priority>2</priority>
        <properties>
            <property name="xpath">
                <value>
                    //*:elements[*:type='Loop']//following-sibling::*[self::*:type='RecordCreate' or self::*:type='RecordUpdate']
                </value>
            </property>
        </properties>
    </rule>

    <!-- ===== GAP 3: Apex Action without Fault Connector ===== -->
    <rule name="ApexActionNoFault"
          language="xml"
          message="Apex Action element has no fault connector – error handling missing."
          class="net.sourceforge.pmd.lang.xml.rule.DomXPathRule">
        <priority>2</priority>
        <properties>
            <property name="xpath">
                <value>
                    //*:elements[*:type='ApexAction' and not(*:faultConnector)]
                </value>
            </property>
        </properties>
    </rule>

    <!-- ===== GAP 4: Guest-exposed Flow Start ===== -->
    <rule name="GuestUserFlowStart"
          language="xml"
          message="Flow is publicly exposed – risk of Broken Access Control."
          class="net.sourceforge.pmd.lang.xml.rule.DomXPathRule">
        <priority>1</priority>
        <properties>
            <property name="xpath">
                <value>
                    //*:start[@isPublic='true']
                </value>
            </property>
        </properties>
    </rule>

    <!-- ===== GAP 5: External Callouts without Named Credential ===== -->
    <rule name="RawHttpCallout"
          language="xml"
          message="Flow makes callout to raw HTTPS endpoint – use Named Credential or whitelist."
          class="net.sourceforge.pmd.lang.xml.rule.DomXPathRule">
        <priority>2</priority>
        <properties>
            <property name="xpath">
                <value>
                    //*:elements/*:assignmentItems/*:value/*:stringValue[
                        matches(string(.), '^https?://', 'i') and not(ancestor::*:Action/*:actionType='NamedCredential')
                    ]
                </value>
            </property>
        </properties>
    </rule>

</ruleset>
