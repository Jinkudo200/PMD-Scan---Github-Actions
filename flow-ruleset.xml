<?xml version="1.0" encoding="UTF-8"?>

<ruleset name="Custom Flow Ruleset - OWASP and Salesforce Security"
         xmlns="http://pmd.sourceforge.net/ruleset/3.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://pmd.sourceforge.net/ruleset/3.0.0
                             https://pmd.github.io/pmd-7.0.0/ruleset_3_0_0.xsd">

    <description>
        Custom PMD ruleset for Salesforce Flow metadata using XPath 3.1 rules (PMD 7).
        Handles XML namespaces correctly and detects common Flow issues and security vulnerabilities.
    </description>

    <!-- Rule 1: Hardcoded email addresses -->
    <rule name="HardcodedEmailInAssignment"
          language="xml"
          message="Avoid hardcoded email addresses in Flow elements."
          class="net.sourceforge.pmd.lang.xml.rule.DomXPathRule">
        <description>Flags stringValue nodes with an email address pattern.</description>
        <priority>2</priority>
        <properties>
            <property name="xpath">
                <value>
                    //*:elements[*:type='Assignment']/*:assignmentItems/*:value/*:stringValue[
                        matches(string(.), '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$')
                    ]
                </value>
            </property>
        </properties>
    </rule>

    <!-- Rule 2: GetRecords without filters -->
    <rule name="UnfilteredGetRecords"
          language="xml"
          message="Avoid GetRecords elements without filter conditions."
          class="net.sourceforge.pmd.lang.xml.rule.DomXPathRule">
        <description>GetRecords should include a filter condition to avoid performance issues.</description>
        <priority>3</priority>
        <properties>
            <property name="xpath">
                <value>
                    //*:elements[*:type='GetRecords' and not(*:getRecords/*:filterLogic)]
                </value>
            </property>
        </properties>
    </rule>

    <!-- Rule 3: Empty Decision elements -->
    <rule name="EmptyDecision"
          language="xml"
          message="Decision element has no conditions defined."
          class="net.sourceforge.pmd.lang.xml.rule.DomXPathRule">
        <description>Detects Decision elements without conditions or outcomes.</description>
        <priority>3</priority>
        <properties>
            <property name="xpath">
                <value>
                    //*:elements[*:type='Decision' and not(*:decisions/*:conditions)]
                </value>
            </property>
        </properties>
    </rule>

    <!-- Rule 4: Hardcoded Salesforce IDs -->
    <rule name="HardcodedIdInFlow"
          language="xml"
          message="Avoid hardcoded Salesforce IDs in Flow assignments."
          class="net.sourceforge.pmd.lang.xml.rule.DomXPathRule">
        <description>Flags string values that match Salesforce ID patterns (15/18 chars).</description>
        <priority>2</priority>
        <properties>
            <property name="xpath">
                <value>
                    //*:elements/*:assignmentItems/*:value/*:stringValue[
                        matches(string(.), '^[a-zA-Z0-9]{15}([a-zA-Z0-9]{3})?$')
                    ]
                </value>
            </property>
        </properties>
    </rule>

    <!-- Rule 5: Hardcoded HTTP URLs -->
    <rule name="InsecureHttpUrl"
          language="xml"
          message="Avoid hardcoded HTTP URLs in Flow elements."
          class="net.sourceforge.pmd.lang.xml.rule.DomXPathRule">
        <description>Flags stringValue nodes containing http:// links.</description>
        <priority>3</priority>
        <properties>
            <property name="xpath">
                <value>
                    //*:elements/*:assignmentItems/*:value/*:stringValue[
                        contains(string(.), 'http://')
                    ]
                </value>
            </property>
        </properties>
    </rule>

    <!-- Rule 6: Unused Variables -->
    <rule name="UnusedVariables"
          language="xml"
          message="Flow variables should have isInput or isOutput flags set."
          class="net.sourceforge.pmd.lang.xml.rule.DomXPathRule">
        <description>Detects variables missing input/output flags.</description>
        <priority>3</priority>
        <properties>
            <property name="xpath">
                <value>
                    //*:variables[not(@isInput) and not(@isOutput)]
                </value>
            </property>
        </properties>
    </rule>

    <!-- Rule 7: Embedded HTML or Script (XSS) -->
    <rule name="EmbeddedHtmlOrScript"
          language="xml"
          message="Embedded HTML or script in strings may lead to XSS when displayed to users."
          class="net.sourceforge.pmd.lang.xml.rule.DomXPathRule">
        <description>Flags stringValue nodes containing HTML tags or script-like content.</description>
        <priority>2</priority>
        <properties>
            <property name="xpath">
                <value>
                    //*:elements/*:assignmentItems/*:value/*:stringValue[
                        matches(string(.), '&lt;[^&gt;]+&gt;', 'i') or
                        matches(string(.), 'script', 'i')
                    ]
                </value>
            </property>
        </properties>
    </rule>

    <!-- Rule 8: Hardcoded Secrets -->
    <rule name="HardcodedSecrets"
          language="xml"
          message="Avoid hardcoded passwords, tokens, or API keys in Flow assignments."
          class="net.sourceforge.pmd.lang.xml.rule.DomXPathRule">
        <description>Flags stringValue nodes containing likely secrets.</description>
        <priority>2</priority>
        <properties>
            <property name="xpath">
                <value>
                    //*:elements/*:assignmentItems/*:value/*:stringValue[
                        matches(string(.), 'password', 'i') or
                        matches(string(.), 'token', 'i') or
                        matches(string(.), 'secret', 'i') or
                        matches(string(.), 'apikey', 'i') or
                        matches(string(.), 'key', 'i')
                    ]
                </value>
            </property>
        </properties>
    </rule>

</ruleset>
